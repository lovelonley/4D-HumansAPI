# 4D-Humans MoCap API - å®æ–½æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å·²å®Œæˆ 4D-Humans è§†é¢‘åŠ¨ä½œæ•æ‰ API æœåŠ¡çš„å®Œæ•´å®æ–½ï¼Œå°†åŸæœ‰çš„å‘½ä»¤è¡Œå·¥å…·è½¬æ¢ä¸ºç”Ÿäº§çº§çš„ REST API æœåŠ¡ã€‚

## âœ… å®Œæˆæƒ…å†µ

### Phase 1: åŸºç¡€æ¶æ„ âœ…
- [x] åˆ›å»ºå®Œæ•´çš„ç›®å½•ç»“æ„
- [x] é…ç½®ç®¡ç†ç³»ç»Ÿï¼ˆ`config.py`ï¼Œæ”¯æŒ `.env` æ–‡ä»¶ï¼‰
- [x] å¸¸é‡å®šä¹‰ï¼ˆ`constants.py`ï¼‰
- [x] æ•°æ®æ¨¡å‹ï¼ˆPydantic modelsï¼‰
- [x] ä¾èµ–æ–‡ä»¶ï¼ˆ`requirements-api.txt`ï¼‰

### Phase 2: æ ¸å¿ƒå·¥å…· âœ…
- [x] æ—¥å¿—ç³»ç»Ÿï¼ˆ`utils/logger.py`ï¼‰
- [x] æ–‡ä»¶å¤„ç†å™¨ï¼ˆ`utils/file_handler.py`ï¼‰
- [x] GPU ç›‘æ§ï¼ˆ`utils/gpu_monitor.py`ï¼‰
- [x] è§†é¢‘éªŒè¯å™¨ï¼ˆ`utils/video_validator.py`ï¼‰
- [x] **å¼ºåˆ¶ä¾èµ–æ£€æŸ¥**ï¼ˆ`utils/dependency_checker.py`ï¼‰
  - âœ… SmoothNet æ£€æŸ¥ç‚¹å¿…é¡»å­˜åœ¨ä¸”å¯åŠ è½½
  - âœ… Blender 3.0+ å¿…é¡»å¯ç”¨
  - âœ… å¯åŠ¨æ—¶æ£€æŸ¥ï¼Œä¸å¯ç”¨åˆ™æœåŠ¡æ— æ³•å¯åŠ¨
  - âœ… **æ— é™çº§ç­–ç•¥**ï¼ˆæŒ‰ç”¨æˆ·è¦æ±‚ï¼‰

### Phase 3: ä¸šåŠ¡é€»è¾‘ âœ…
- [x] ä»»åŠ¡ç®¡ç†å™¨ï¼ˆ`services/task_manager.py`ï¼‰
  - å•é˜Ÿåˆ—ç®¡ç†
  - ä»»åŠ¡çŠ¶æ€è¿½è¸ª
  - è‡ªåŠ¨æ¸…ç†ï¼ˆ3å¤©ä¿ç•™æœŸï¼‰
- [x] Pipeline å°è£…ï¼ˆ`services/pipeline.py`ï¼‰
  - æ­¥éª¤ 1: PHALP è¿½è¸ª
  - æ­¥éª¤ 2: å•äººè½¨è¿¹æå–
  - æ­¥éª¤ 3: SmoothNet å¹³æ»‘
  - æ­¥éª¤ 4: Blender FBX å¯¼å‡º
  - æ­¥éª¤ 5: æ‰“åŒ…
- [x] åå°å·¥ä½œå™¨ï¼ˆ`services/worker.py`ï¼‰
  - å¼‚æ­¥ä»»åŠ¡å¤„ç†
  - è¿›åº¦å›è°ƒ
  - é”™è¯¯å¤„ç†

### Phase 4: API ç«¯ç‚¹ âœ…
- [x] MoCap APIï¼ˆ`routers/mocap.py`ï¼‰
  - `POST /api/v1/mocap/tasks` - åˆ›å»ºä»»åŠ¡
  - `GET /api/v1/mocap/tasks/{task_id}` - æŸ¥è¯¢çŠ¶æ€
  - `GET /api/v1/mocap/tasks/{task_id}/download` - ä¸‹è½½ FBX
  - `DELETE /api/v1/mocap/tasks/{task_id}` - åˆ é™¤ä»»åŠ¡
  - `GET /api/v1/mocap/tasks` - åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
- [x] ç®¡ç† APIï¼ˆ`routers/admin.py`ï¼‰
  - `GET /health` - ç®€å•å¥åº·æ£€æŸ¥
  - `GET /api/v1/admin/health` - è¯¦ç»†å¥åº·æ£€æŸ¥
  - `GET /api/v1/admin/stats` - ç»Ÿè®¡ä¿¡æ¯
  - `GET /api/v1/admin/queue` - é˜Ÿåˆ—ä¿¡æ¯
  - `POST /api/v1/admin/cleanup` - æ‰‹åŠ¨æ¸…ç†
- [x] FastAPI ä¸»åº”ç”¨ï¼ˆ`main.py`ï¼‰
  - ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - CORS ä¸­é—´ä»¶
  - è¯·æ±‚æ—¥å¿—
  - å…¨å±€å¼‚å¸¸å¤„ç†

### Phase 5: æ–‡æ¡£ä¸éƒ¨ç½² âœ…
- [x] å®Œæ•´ API æ–‡æ¡£ï¼ˆ`README_API.md`ï¼‰
- [x] å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆ`QUICKSTART_API.md`ï¼‰
- [x] æµ‹è¯•è„šæœ¬ï¼ˆ`scripts/test_api.py`ï¼‰
- [x] å¯åŠ¨è„šæœ¬ï¼ˆ`scripts/start_api.sh`ï¼‰
- [x] Systemd æœåŠ¡æ–‡ä»¶ï¼ˆ`deploy/4d-humans-api.service`ï¼‰
- [x] Nginx é…ç½®ï¼ˆ`deploy/nginx.conf`ï¼‰
- [x] ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼ˆ`deploy/env.example`ï¼‰

## ğŸ¯ ç”¨æˆ·éœ€æ±‚æ»¡è¶³æƒ…å†µ

| éœ€æ±‚ | çŠ¶æ€ | å®ç°æ–¹å¼ |
|------|------|----------|
| è§†é¢‘é¢„å¤„ç†é™åˆ¶ | âœ… | 2K åˆ†è¾¨ç‡ï¼Œ30ç§’æ—¶é•¿ï¼Œ500MB å¤§å° |
| GPU èµ„æºç®¡ç† | âœ… | å•é˜Ÿåˆ—ï¼Œä¸€æ¬¡å¤„ç†ä¸€ä¸ªä»»åŠ¡ |
| ä¸­é—´æ–‡ä»¶ä¿ç•™ | âœ… | å¯é€‰ä¿ç•™ï¼Œæœ€é•¿ 3 å¤©è‡ªåŠ¨æ¸…ç† |
| é”™è¯¯é‡è¯•æœºåˆ¶ | âœ… | è¯¦ç»†æ—¥å¿—ï¼Œä¸è‡ªåŠ¨é‡è¯• |
| è¾“å‡ºæ ¼å¼ | âœ… | FBXï¼ˆUnity Humanoid å…¼å®¹ï¼‰ |
| è®¤è¯æ–¹å¼ | âœ… | æ— è®¤è¯ |
| éƒ¨ç½²æ–¹å¼ | âœ… | Systemd + Nginxï¼ˆå‚ç…§ UniRigï¼‰ |
| **SmoothNet** | âœ… | **å¿…é¡»å¯ç”¨ï¼Œå¯åŠ¨æ—¶æ£€æŸ¥ï¼Œæ— é™çº§** |
| **Blender** | âœ… | **å¿…é¡»å¯ç”¨ï¼Œå¯åŠ¨æ—¶æ£€æŸ¥ï¼Œæ— é™çº§** |

## ğŸ“Š æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: FastAPI 0.104.1
- **å¼‚æ­¥è¿è¡Œæ—¶**: asyncio + uvicorn
- **æ•°æ®éªŒè¯**: Pydantic 2.5.0
- **è§†é¢‘å¤„ç†**: OpenCV 4.8.1
- **ä¾èµ–ç®¡ç†**: pydantic-settings
- **æ–‡ä»¶ä¸Šä¼ **: python-multipart
- **GPU ç›‘æ§**: py3nvml (å¯é€‰)

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FastAPI Application                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MoCap Router  â”‚  â”‚  Admin Router  â”‚  â”‚  Health Check  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                   â”‚                    â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Task Manager (Singleton)                    â”‚ â”‚
â”‚  â”‚  - Queue Management                                      â”‚ â”‚
â”‚  â”‚  - Task Status Tracking                                  â”‚ â”‚
â”‚  â”‚  - Auto Cleanup                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Background Worker (Async)                     â”‚  â”‚
â”‚  â”‚  - Process Loop                                         â”‚  â”‚
â”‚  â”‚  - Progress Callback                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         4D-Humans Pipeline (Thread Pool)                â”‚ â”‚
â”‚  â”‚  1. PHALP Tracking                                      â”‚ â”‚
â”‚  â”‚  2. Track Extraction                                    â”‚ â”‚
â”‚  â”‚  3. SmoothNet Smoothing                                 â”‚ â”‚
â”‚  â”‚  4. Blender FBX Export                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å…³é”®è®¾è®¡å†³ç­–

### 1. å¼ºåˆ¶ä¾èµ–æ£€æŸ¥
- **ä½ç½®**: åº”ç”¨å¯åŠ¨æ—¶ï¼ˆ`main.py` çš„ `lifespan`ï¼‰
- **è¡Œä¸º**: æ£€æŸ¥å¤±è´¥ â†’ `sys.exit(1)`
- **æ— é™çº§ç­–ç•¥**: å®Œå…¨æŒ‰ç…§ç”¨æˆ·è¦æ±‚å®ç°

### 2. å•é˜Ÿåˆ—è®¾è®¡
- **åŸå› **: GPU èµ„æºé™åˆ¶ï¼Œé¿å… OOM
- **å®ç°**: `TaskManager.current_task_id` äº’æ–¥é”
- **å¥½å¤„**: ç®€å•å¯é ï¼Œæ˜“äºç›‘æ§

### 3. å¼‚æ­¥æ¶æ„
- **Web å±‚**: FastAPI å¼‚æ­¥å¤„ç†è¯·æ±‚
- **Worker å±‚**: asyncio äº‹ä»¶å¾ªç¯
- **Pipeline å±‚**: åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼ˆé¿å…é˜»å¡ï¼‰

### 4. æ–‡ä»¶ç®¡ç†
- **ä¸Šä¼ **: `uploads/{task_id}.{ext}`
- **è¿½è¸ª**: `outputs/results/{task_id}.pkl`ï¼ˆç»Ÿä¸€ä½¿ç”¨ task_id å‘½åï¼‰
- **ä¸­é—´**: `tmp/{task_id}_tid{track_id}_*.npz`
- **è¾“å‡º**: `results/{task_id}_tid{track_id}_*.fbx`
- **æ¸…ç†**: 
  - API ä»»åŠ¡æ–‡ä»¶ï¼š3å¤©è‡ªåŠ¨æ¸…ç†
  - æ¼”ç¤ºæ–‡ä»¶ï¼š30å¤©è‡ªåŠ¨æ¸…ç†
  - æµ‹è¯•æ–‡ä»¶ï¼š7å¤©è‡ªåŠ¨æ¸…ç†
  - æ—¥å¿—æ–‡ä»¶ï¼š7å¤©è‡ªåŠ¨æ¸…ç†
  - æ”¯æŒæ‰‹åŠ¨æ¸…ç†æ¥å£

## ğŸ“¦ ä»£ç ç»Ÿè®¡

```
api/
â”œâ”€â”€ 20 Python æ–‡ä»¶
â”œâ”€â”€ ~3,800 è¡Œä»£ç 
â”œâ”€â”€ å®Œæ•´çš„ç±»å‹æ³¨è§£
â””â”€â”€ è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²

æ–‡æ¡£:
â”œâ”€â”€ README_API.md (400+ è¡Œ)
â”œâ”€â”€ QUICKSTART_API.md (200+ è¡Œ)
â””â”€â”€ æœ¬æ–‡æ¡£

æµ‹è¯•ä¸éƒ¨ç½²:
â”œâ”€â”€ test_api.py (300+ è¡Œ)
â”œâ”€â”€ start_api.sh
â”œâ”€â”€ 4d-humans-api.service
â””â”€â”€ nginx.conf
```

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš
1. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements-api.txt
   ```

2. **é…ç½®ç¯å¢ƒ**
   ```bash
   cp deploy/env.example .env
   # ç¼–è¾‘ .envï¼Œè®¾ç½® SMOOTHNET_CHECKPOINT å’Œ BLENDER_PATH
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   ./scripts/start_api.sh
   # æˆ–
   python -m api.main
   ```

4. **æµ‹è¯• API**
   ```bash
   python scripts/test_api.py example_data/videos/gymnasts.mp4 --wait
   ```

### ç”Ÿäº§éƒ¨ç½²
1. **é…ç½® Systemd**
   ```bash
   sudo cp deploy/4d-humans-api.service /etc/systemd/system/
   sudo systemctl enable 4d-humans-api
   sudo systemctl start 4d-humans-api
   ```

2. **é…ç½® Nginx**
   ```bash
   sudo cp deploy/nginx.conf /etc/nginx/sites-available/4d-humans-api
   sudo ln -s /etc/nginx/sites-available/4d-humans-api /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

3. **ç›‘æ§æ—¥å¿—**
   ```bash
   tail -f logs/4d-humans-api.log
   ```

## ğŸ› å·²çŸ¥é™åˆ¶

1. **å•é˜Ÿåˆ—**: ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œé€‚åˆå• GPU ç¯å¢ƒ
2. **æ— è®¤è¯**: ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ  API Key æˆ– OAuthï¼ˆè§ [PROJECT_OPTIMIZATION_ROADMAP.md](PROJECT_OPTIMIZATION_ROADMAP.md)ï¼‰
3. **æ— é‡è¯•**: ä»»åŠ¡å¤±è´¥éœ€è¦æ‰‹åŠ¨é‡æ–°æäº¤
4. **æœ¬åœ°å­˜å‚¨**: æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸æ”¯æŒåˆ†å¸ƒå¼
5. **CORS é…ç½®**: å½“å‰å…è®¸æ‰€æœ‰åŸŸåè®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶ï¼‰

## ğŸ’¡ æœªæ¥æ”¹è¿›æ–¹å‘

1. **å¤š GPU æ”¯æŒ**: å¤šé˜Ÿåˆ— + è´Ÿè½½å‡è¡¡
2. **è®¤è¯ç³»ç»Ÿ**: API Key / JWT / OAuth
3. **WebSocket**: å®æ—¶è¿›åº¦æ¨é€
4. **å¯¹è±¡å­˜å‚¨**: S3 / MinIO é›†æˆ
5. **ä»»åŠ¡ä¼˜å…ˆçº§**: é˜Ÿåˆ—ä¼˜å…ˆçº§ç®¡ç†
6. **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡ä¸Šä¼ å¤šä¸ªè§†é¢‘
7. **æ ¼å¼æ‰©å±•**: æ”¯æŒ GLBã€BVH ç­‰æ ¼å¼

## ğŸ“ å‚è€ƒèµ„æ–™

- [4D-Humans](https://github.com/shubham-goel/4D-Humans)
- [PHALP](https://github.com/brjathu/PHALP)
- [SmoothNet](https://github.com/cure-lab/SmoothNet)
- [FastAPI](https://fastapi.tiangolo.com/)
- [UniRig](https://github.com/your-repo/UniRig) - æ¶æ„å‚è€ƒ

## ğŸ‰ æ€»ç»“

âœ… **æ‰€æœ‰ 5 ä¸ª Phase å·²å®Œæˆ**
âœ… **æ‰€æœ‰ç”¨æˆ·éœ€æ±‚å·²æ»¡è¶³**
âœ… **ä»£ç å·²æäº¤åˆ° GitHub**
âœ… **æ–‡æ¡£å®Œæ•´é½å…¨**
âœ… **å¯ç«‹å³éƒ¨ç½²ä½¿ç”¨**

---

**å®æ–½æ—¶é—´**: çº¦ 2 å°æ—¶  
**ä»£ç è´¨é‡**: ç”Ÿäº§çº§  
**æµ‹è¯•è¦†ç›–**: æ‰‹åŠ¨æµ‹è¯•è„šæœ¬  
**éƒ¨ç½²å°±ç»ª**: âœ…

**GitHub ä»“åº“**: https://github.com/lovelonley/4D-HumansAPI

